<Sysmon schemaversion="4.22">

	<HashAlgorithms>md5,sha256</HashAlgorithms>
	<CheckRevocation/>
	
	<EventFiltering>
		<RuleGroup name="" groupRelation="or">		
			<!-- Event ID 1 == Process Creation. -->
			<ProcessCreate onmatch="include">
				<Image condition="end with" name="T1086">powershell.exe</Image>
				<Image condition="contains" name="T1086">.ps1</Image>
				<Image condition="contains" name="T1086">.ps2</Image>
				<Image condition="end with" name="T1059">cmd.exe</Image>
				<Image condition="end with" name="T1117">regsvr32.exe</Image>
				<Image condition="end with" name="T1059">vshadow.exe</Image>
				<Image condition="end with" name="T1202">forfiles.exe</Image>
				<Image condition="end with" name="T1085">rundll32.exe</Image>
				<Image condition="image" name="T1117">regsvr32.exe</Image>
				<Image condition="end with" name="T1085">dllhost.exe</Image>
				<Image condition="end with" name="T1059">cscript.exe</Image>
				<Image condition="end with" name="T1059">wscript.exe</Image>
				<Image condition="end with" name="T1059">hh.exe</Image>
				<Image condition="end with" name="T1059">bash.exe</Image>
				<Image condition="end with" name="T1059">scrcons.exe</Image>
				<Image condition="end with" name="T1059">schtasks.exe</Image>
				<Image condition="end with" name="T1059">sh.exe</Image>
				<Image condition="end with" name="S0160">certutil.exe</Image>
				<Image condition="contains" name="T1036">*\PerfLogs\*</Image>
				<Image condition="contains" name="T1036">*\$Recycle.bin\*</Image>
				<Image condition="contains" name="T1036">*\Intel\Logs\*</Image>
				<Image condition="contains" name="T1036">*\Users\All Users\*</Image>
				<Image condition="contains" name="T1036">*\Users\Default\*</Image>
				<Image condition="contains" name="T1036">*\Users\Public\*</Image>
				<Image condition="contains" name="T1036">*\Users\NetworkService\*</Image>
				<Image condition="contains" name="T1036">*\Windows\Fonts\*</Image>
				<Image condition="contains" name="T1036">*\Windows\Debug\*</Image>
				<Image condition="contains" name="T1036">*\Windows\Media\*</Image>
				<Image condition="contains" name="T1036">*\Windows\IME\*</Image>
				<Image condition="contains" name="T1036">*\Windows\Help\*</Image>
				<Image condition="contains" name="T1036">*\Windows\addins\*</Image>
				<Image condition="contains" name="T1036">*\Windows\repair\*</Image>
				<Image condition="contains" name="T1036">*\Windows\security\*</Image>
				<Image condition="contains" name="T1036">*\RSA\MachineKeys\*</Image>
				<Image condition="contains" name="T1036">*\wwwroot\*</Image>
				<Image condition="contains" name="T1036">*\wmpub\*</Image>
				<Image condition="contains" name="T1036">*\htdocs\*</Image>
				<Image condition="contains" name="T1036">*\Windows\system32\config\systemprofile\*</Image>
				<Image condition="end with" name="T1135">net.exe</Image>
				<Image condition="end with" name="T1135">net1.exe</Image>
				<Image condition="end with" name="T1047">wmic.exe</Image>
				<Image condition="end with" name="T1197">bitsadmin.exe</Image>
				<Image condition="end with" name="T1059">conhost.exe</Image>
									  
				<CommandLine condition="contains" name="T1056">*/stext*</CommandLine>
				<CommandLine condition="contains" name="T1056">*/scomma*</CommandLine>
				<CommandLine condition="contains" name="T1191">*cmstp.exe*/s*</CommandLine>
				<CommandLine condition="contains" name="T1088">*cmstp.exe*/au*</CommandLine>
				<CommandLine condition="contains" name="T1090">*netsh*connectp=3389*</CommandLine>
				<CommandLine condition="contains" name="T1158">attrib +h</CommandLine>
				<CommandLine condition="contains" name="T1089">*unload*sysmon*</CommandLine>
				<CommandLine condition="contains" name="T1053">*schtasks.exe*/create*c:\users\*</CommandLine>
				<CommandLine condition="contains" name="T1053">*schtasks.exe*/create*c:\programdata\*</CommandLine>
				<CommandLine condition="contains" name="T1053">*schtasks.exe*/create*c:\windows\temp\*</CommandLine>
				<CommandLine condition="contains" name="T1086">*new-object system.net.webclient).downloadstring(*</CommandLine>
				<CommandLine condition="contains" name="T1086">*new-object system.net.webclient).downloadfile(*</CommandLine>
				<CommandLine condition="contains" name="T1086"> -enc </CommandLine>
				<CommandLine condition="contains" name="T1086"> -EncodedCommand </CommandLine>
				<CommandLine condition="contains" name="T1086"> -w hidden </CommandLine>
				<CommandLine condition="contains" name="T1086"> -window hidden </CommandLine>
				<CommandLine condition="contains" name="T1086"> -windowstyle hidden </CommandLine>
				<CommandLine condition="contains" name="T1086"> -noni </CommandLine>
				<CommandLine condition="contains" name="T1086"> -noninteractive </CommandLine>		  
				<CommandLine condition="contains" name="T1140">*\certutil.exe * -decode *</CommandLine>
				<CommandLine condition="contains" name="T1140">*\certutil.exe * -decodehex *</CommandLine>
				<CommandLine condition="contains" name="T1105">*\certutil.exe *-urlcache* http*</CommandLine>
				<CommandLine condition="contains" name="T1105">*\certutil.exe *-urlcache* ftp*</CommandLine>
				<CommandLine condition="contains" name="T1105">*\certutil.exe *-URL*</CommandLine>
				<CommandLine condition="contains" name="T1105">*\certutil.exe *-ping*</CommandLine>
				<CommandLine condition="contains" name="T1087">net*group*</CommandLine>
				<CommandLine condition="contains" name="T1087">net*localgroup*</CommandLine>
				<CommandLine condition="contains" name="T1087">net*view*</CommandLine>
				<CommandLine condition="contains" name="T1087">net*share</CommandLine>
				<CommandLine condition="contains" name="T1087">net*account*</CommandLine>
				<CommandLine condition="contains" name="T1087">net*use*</CommandLine>
				<CommandLine condition="contains" name="T1059">vssadmin.exe Delete Shadows</CommandLine>
				<CommandLine condition="contains" name="T1059">vssadmin create shadow /for=*:</CommandLine>
				<CommandLine condition="contains" name="T1059">vssadmin delete shadows /for=*:</CommandLine>
				<CommandLine condition="contains" name="T1059">copy \\?\GLOBALROOT\Device\*\windows\ntds\ntds.dit</CommandLine>
				<CommandLine condition="contains" name="T1059">copy \\?\GLOBALROOT\Device\*\config\SAM</CommandLine>
				<CommandLine condition="contains" name="T1059">reg SAVE HKLM\SYSTEM </CommandLine>
				<CommandLine condition="contains" name="T1210">*transport=dt_socket,address=*</CommandLine>
				<CommandLine condition="contains" name="T1089">//e:{16d51579-a30b-4c8b-a276-0ff4dc41e755}</CommandLine>
				<CommandLine condition="contains" name="T1490">*shadowcopy delete*</CommandLine>
				<CommandLine condition="contains" name="T1490">*vssadmin.exe Delete Shadows*</CommandLine>
		  
				<ParentImage condition="end with" name="T1170">mshta.exe</ParentImage>
				<ParentImage condition="end with" name="T1028">wsmprovhost.exe</ParentImage>
				<ParentImage condition="contains" name="T1028">WinrsHost.exe</ParentImage>
				<ParentImage condition="end with" name="T1059">WINWORD.exe</ParentImage>
				<ParentImage condition="end with" name="T1059">EXCEL.exe</ParentImage>
				<ParentImage condition="end with" name="T1059">POWERPNT.exe</ParentImage>
				<ParentImage condition="end with" name="T1059">MSPUB.exe</ParentImage>
				<ParentImage condition="end with" name="T1059">VISIO.exe</ParentImage>
				<ParentImage condition="end with" name="T1085">control.exe</ParentImage>
				<ParentImage condition="end with" name="T1175">mmc.exe</ParentImage>
				<ParentImage condition="contains" name="T1059">cscript.exe</ParentImage>
				<ParentImage condition="contains" name="T1059">wscript.exe</ParentImage>
				<ParentImage condition="end with" name="T1218">msiexec.exe</ParentImage>
			  
				<ParentCommandLine condition="is" name="T1088">C:\Windows\System32\eventvwr.exe</ParentCommandLine>
				<ParentCommandLine condition="contains" name="T1055">\\.\pipe</ParentCommandLine>
				<ParentCommandLine condition="contains" name="T1218">ftp -s:</ParentCommandLine>
				<ParentCommandLine condition="contains" name="T1218">pcalua.exe -a</ParentCommandLine>
			</ProcessCreate>
		</RuleGroup>
		
		<RuleGroup name="" groupRelation="or">	  
			<!-- Event ID 2 == File Creation Time. -->
			<FileCreateTime onmatch="include">
			</FileCreateTime>
		</RuleGroup>
			  
			
		<RuleGroup name="" groupRelation="or">
			<!-- Event ID 3 == Network Connection. -->
			<NetworkConnect onmatch="include">
				<Image condition="image" name="T1175">mshta.exe</Image>
				<Image condition="image" name="T1059">certutil.exe</Image>
				<Image condition="image" name="T1117">regsvr32.exe</Image>
				<Image condition="end with" name="T1085">rundll32.exe</Image>
				<Image condition="image" name="T1086">powershell.exe</Image>
				
				<DestinationIp condition="is" name="T1090">127.0.0.1</DestinationIp>
				<DestinationIp condition="is" name="T1090">::1</DestinationIp>
				
				<DestinationPort condition="is" name="T1090">3389</DestinationPort>
				<DestinationPort condition="is" name="T1090">445</DestinationPort>
			</NetworkConnect>
		</RuleGroup>	
			
			<!--Event ID 4 : RESERVED FOR SYSMON SERVICE STATUS MESSAGES CAN NOT BE FILTERED-->
		
		<RuleGroup name="" groupRelation="or">
			<!-- Event ID 5 == Process Terminated. -->
			<ProcessTerminate onmatch="include">
			</ProcessTerminate>
		</RuleGroup>	
		
		<RuleGroup name="" groupRelation="or">
			<!-- Event ID 6 == Driver Loaded. -->
			<!--TECHNICAL:	If exclude it's used Sysmon will check the signing certificate revocation status of any driver you don't exclude.-->
			<DriverLoad onmatch="include">
				<ImageLoaded condition="contains" name="T1014">\Temp</ImageLoaded>
			</DriverLoad>		
		</RuleGroup>
		
		<RuleGroup name="" groupRelation="or">	
			<!-- Event ID 7 == Image Load-->
			<ImageLoad onmatch="include">
				<Signed condition="is" name="T1073">false</Signed>
			</ImageLoad>
		</RuleGroup>
		
		<RuleGroup name="" groupRelation="or">
			<!-- Event ID 8 == CreateRemoteThread. -->
			<CreateRemoteThread onmatch="include">
				<TargetImage condition="is" name="S0121">C:\Windows\system32\lsass.exe</TargetImage>
			</CreateRemoteThread>
		</RuleGroup>
		
		<RuleGroup name="" groupRelation="or">
			<!-- Event ID 9 == RawAccessRead. -->
			<RawAccessRead onmatch="include">
			</RawAccessRead>
		</RuleGroup>
		
		<!-- Event ID 10 == ProcessAccess. -->
		<RuleGroup name="" groupRelation="or">
			<ProcessAccess onmatch="exclude">
				<SourceImage condition="end with" name="T1003">wmiprvse.exe</SourceImage>
				<SourceImage condition="end with" name="T1003">GoogleUpdate.exe</SourceImage>
				<SourceImage condition="end with" name="T1003">LTSVC.exe</SourceImage>
				<SourceImage condition="end with" name="T1003">VBoxService.exe</SourceImage> <!--# Virtual Box -->
				<SourceImage condition="end with" name="T1003">vmtoolsd.exe</SourceImage>
				<SourceImage condition="end with" name="T1003">\Citrix\System32\wfshell.exe</SourceImage> <!--#Citrix process in C:\Program Files (x86)\Citrix\System32\wfshell.exe -->
				<SourceImage condition="is" name="T1003">C:\Windows\System32\lsm.exe</SourceImage> <!--# System process under C:\Windows\System32\lsm.exe -->
				<SourceImage condition="end with" name="T1003">Microsoft.Identity.AadConnect.Health.AadSync.Host.exe</SourceImage> <!--# Microsoft Azure AD Connect Health Sync Agent -->
				<SourceImage condition="begin with" name="T1003">C:\Program Files (x86)\Symantec\Symantec Endpoint Protection</SourceImage> <!-- # Symantec -->
			</ProcessAccess>
		</RuleGroup>	
		<RuleGroup name="" groupRelation="or">
			<ProcessAccess onmatch="include">
				<CallTrace condition="contains" name="T1003">dbghelp.dll</CallTrace>
				<CallTrace condition="contains" name="T1003">dbgcore.dll</CallTrace>
				<CallTrace condition="contains" name="T1003">mimikatz</CallTrace>
				
				<TargetImage condition="contains" name="T1003">lsass.exe</TargetImage>
				
				<GrantedAccess condition="is" name="T1093">0x800</GrantedAccess>
			</ProcessAccess>
		</RuleGroup>
		
		<RuleGroup name="" groupRelation="or">	
			<!-- Event ID 11 == FileCreate. -->
			<FileCreate onmatch="include">
				<TargetFilename condition="is" name="T1088">*\AppData\Local\Temp\comctl32.dll</TargetFilename>
				<TargetFilename condition="is" name="T1088">*\AppData\Local\Temp\dismcore.dll</TargetFilename>
				<TargetFilename condition="is" name="T1088">*\AppData\Local\Temp\wow64log.dll</TargetFilename>
				<TargetFilename condition="contains" name="T1053">aitagent.exe</TargetFilename>
				<TargetFilename condition="contains" name="T1053">DiagTrackRunner.exe</TargetFilename>
				<TargetFilename condition="contains" name="T1053">CompatTelRunner.exe</TargetFilename>
				<TargetFilename condition="contains" name="T1053">acproxy.dl</TargetFilename>
				<TargetFilename condition="contains" name="T1053">wsqmcons.exe</TargetFilename>
				<TargetFilename condition="contains" name="T1053">lpremove.exe</TargetFilename>
				<TargetFilename condition="contains" name="T1053">srrstr.dll</TargetFilename>
				<TargetFilename condition="contains" name="T1053">wermgr.exe</TargetFilename>
				<TargetFilename condition="contains" name="T1053">sdclt.exe</TargetFilename>
				<TargetFilename condition="contains" name="T1053">appidcertstorecheck.exe</TargetFilename>
				<TargetFilename condition="contains" name="T1053">AppHostRegistrationVerifier.exe</TargetFilename>
				<TargetFilename condition="contains" name="T1053">MicTray64.exe</TargetFilename>
				<TargetFilename condition="contains" name="T1053">usoclient.exe</TargetFilename>
				<TargetFilename condition="contains" name="T1053">dsregcmd.exe</TargetFilename>
				<TargetFilename condition="contains" name="T1053">sihclient.exe</TargetFilename>
				<TargetFilename condition="contains" name="T1053">dimsjob.dll</TargetFilename>
				<TargetFilename condition="contains" name="T1053">Lracengn.dll</TargetFilename>
				<TargetFilename condition="contains" name="T1053">HotstartUserAgent.dll</TargetFilename>
				<TargetFilename condition="contains" name="T1053">MsCtfMonitor.dll</TargetFilename>
				<TargetFilename condition="contains" name="T1053">PlaySndSrv.dll</TargetFilename>
				<TargetFilename condition="contains" name="T1053">AdobeARM.exe</TargetFilename>
				<TargetFilename condition="contains" name="T1053">GoogleUpdate.exe</TargetFilename>
				<TargetFilename condition="end with" name="T1129">\UsageLogs\cscript.exe.log</TargetFilename>
				<TargetFilename condition="end with" name="T1129">\UsageLogs\wscript.exe.log</TargetFilename>
				<TargetFilename condition="end with" name="T1129">\UsageLogs\mshta.log</TargetFilename>
				<TargetFilename condition="end with" name="T1129">\UsageLogs\wmic.log</TargetFilename>
				<TargetFilename condition="end with" name="T1129">\UsageLogs\regsvr32.exe.log</TargetFilename>
				<TargetFilename condition="end with" name="T1129">\UsageLogs\svchost.log</TargetFilename>
				<TargetFilename condition="contains" name="T1088">*\AppData\Local\Temp\mscoree.dll</TargetFilename>
				<TargetFilename condition="contains" name="T1088">*\AppData\Local\Temp\GdiPlus.dll</TargetFilename>
				<TargetFilename condition="begin with" name="T1138">C:\Windows\AppPatch\Custom</TargetFilename> <!--Windows: Application compatibility shims [ https://www.fireeye.com/blog/threat-research/2017/05/fin7-shim-databases-persistence.html ] -->
			</FileCreate>
		</RuleGroup>
		
		<RuleGroup name="" groupRelation="or">	
			<!-- Event ID 12,13,14 == RegObject added/deleted, RegValue Set, RegObject Renamed. -->
			<RegistryEvent onmatch="include">
				<TargetObject condition="is" name="T1088">HKU\*\exefile\shell\runas\command\IsolatedCommand</TargetObject>
				<TargetObject condition="is" name="T1088">HKU\*\ms-settings\shell\open\command\DelegateExecute</TargetObject>
				<TargetObject condition="is" name="T1088">HKU\*\ms-settings\shell\open\command\(Default)</TargetObject>
				<TargetObject condition="is" name="T1088">HKU\*\ms-settings\shell\open\command</TargetObject>
				<TargetObject condition="is" name="T1089">HKLM\System\CurrentControlSet\Control\SESSION MANAGER\Environment\__PSLockdownPolicy</TargetObject>
				<TargetObject condition="is" name="T1088">HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\policies\system\EnableLUA</TargetObject>
				<TargetObject condition="is" name="T1089">HKLM\SOFTWARE\Wow6432Node\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging\EnableScriptBlockLogging</TargetObject>
				<TargetObject condition="is" name="T1089">HKLM\SOFTWARE\Microsoft\PowerShell\1\ShellIds\Microsoft.PowerShell\ExecutionPolicy</TargetObject>
				<TargetObject condition="is" name="T1089">HKU\*\Software\Microsoft\Office\*\Excel\Security\AccessVBOM</TargetObject>
				<TargetObject condition="is" name="T1089">HKU\*\Software\Microsoft\Office\*\PowerPoint\Security\AccessVBOM</TargetObject>
				<TargetObject condition="is" name="T1089">HKU\*\Software\Microsoft\Office\*\Word\Security\AccessVBOM</TargetObject>
				<TargetObject condition="is" name="T1089">HKU\*\Software\Microsoft\Office\*\Access\Security\AccessVBOM</TargetObject>
				<TargetObject condition="is" name="T1089">HKU\*\Software\Microsoft\Office\*\Outlook\Security\AccessVBOM</TargetObject>
				<TargetObject condition="is" name="T1130">HKLM\SOFTWARE\Policies\Microsoft\SystemCertificates\Root\Certificates</TargetObject>
				<TargetObject condition="contains" name="T1060">Windows\CurrentVersion\Run</TargetObject>
				<TargetObject condition="contains" name="T1060">Windows\CurrentVersion\RunOnce</TargetObject>
				<TargetObject condition="begin with" name="T1138,AppCompatShim">HKLM\Software\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\Custom</TargetObject> <!--Windows: AppCompat [ https://www.fireeye.com/blog/threat-research/2017/05/fin7-shim-databases-persistence.html ] -->
				<TargetObject condition="begin with" name="T1138,AppCompatShim">HKLM\Software\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\InstalledSDB</TargetObject> <!--Windows: AppCompat [ https://attack.mitre.org/wiki/Technique/T1138 ] -->
				<TargetObject condition="contains" name="T1015">\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.exe\Debugger</TargetObject>
				<TargetObject condition="contains" name="T1015">\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.exe\Debugger</TargetObject>
				<TargetObject condition="contains" name="T1015">\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\osk.exe\Debugger</TargetObject>
				<TargetObject condition="contains" name="T1015">\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\Magnify.exe\Debugger</TargetObject>
				<TargetObject condition="contains" name="T1015">\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\Narrator.exe\Debugger</TargetObject>
				<TargetObject condition="contains" name="T1015">\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\DisplaySwitch.exe\Debugger</TargetObject>
			</RegistryEvent>
		</RuleGroup>
				
		<RuleGroup name="" groupRelation="or">
			<!-- Event ID 15 == FileStream Created. -->
			<FileCreateStreamHash onmatch="include">
			</FileCreateStreamHash>
		</RuleGroup>
		
		<RuleGroup name="" groupRelation="or">
			<!-- Event ID 17,18 == PipeEvent. Log Named pipe created & Named pipe connected -->
			<PipeEvent onmatch="include">
			</PipeEvent>
		</RuleGroup>
		
		<RuleGroup name="" groupRelation="or">
			<!-- Event ID 19,20,21, == WmiEvent. Log WmiEventFilter, WmiEventConsumer, WmiEventConsumerToFilter creation activity-->
			<WmiEvent onmatch="include">
				<Operation condition="is" name="T1047">Created</Operation>
			</WmiEvent>
		</RuleGroup>
		
		<RuleGroup name="" groupRelation="or">
			<!-- Event ID 22 == DNSQuery-->
			<DnsQuery onmatch="include">
			</DnsQuery>
		</RuleGroup>
		
	</EventFiltering>
</Sysmon>
